<!DOCTYPE html>
<html>
<meta charset="utf-8">
<title>Next Train: Paddington to Tilehurst</title>

<!-- 
    CURRENT IMPLEMENTATION: Client-Side Dynamic HTML Generation
    
    This is a Single Page Application (SPA) approach where:
    1. The HTML provides only the basic structure and styling
    2. All train data fetching and display happens via JavaScript
    3. The page dynamically updates without full page reloads
    4. Real-time countdown timer runs in the browser
    5. Smart refresh intervals based on how close the train is
    
    ARCHITECTURE:
    - Static HTML container with minimal content
    - JavaScript fetches data from /api/next-train/PAD/TLH endpoint
    - DOM manipulation updates the display with fresh train data
    - setInterval() runs countdown timer every second
    - setTimeout() schedules next data refresh based on departure proximity
-->

<body style="
    margin:0;
    min-height:100vh;          /* fallback */
    min-height:100dvh;         /* mobile-safe */
    font-family:monospace;
    background:#fff;
  ">

    <main style="
      padding:1em;
      line-height:1.4;
      font-size:14px;
    ">
        <!-- Static header text - never changes -->
        <div style="margin:0 0 6px 0;font-family: 'Courier New', monospace; font-size: 24px; color: #666;">Next train
            from Paddington to Tilehurst departs in</div>

        <!-- Dynamic content container - populated by JavaScript -->
        <div id="train-display">
            <div>Loading departure information...</div>
        </div>
    </main>


    <script>
        // Auto-start train data fetch and countdown
        getNextTrain();

        // Global variable to store current departure time for smart refresh calculations
        let currentDepartureTime = null;

        // Function to get the next train data from the server API endpoint
        async function getNextTrain() {
            const display = document.getElementById('train-display');

            // Clear any existing countdown timer to prevent multiple timers running
            clearCountdown();

            try {
                // Fetch train data from the server API endpoint
                // This makes an HTTP request to the Express server running on port 3000
                const response = await fetch('/api/next-train/PAD/TLH');

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // Parse the JSON response from the server
                const data = await response.json();

                // Check if we got valid departure data
                if (data.departures && data.departures.length > 0) {
                    const nextTrain = data.departures[0];
                    const service = nextTrain.service;

                    // Store the departure time globally for smart refresh calculation
                    // Use expected time if available and not "On time", otherwise use scheduled time
                    currentDepartureTime = service.etd && service.etd !== 'On time' ? service.etd : service.std;

                    // DYNAMIC HTML GENERATION: Build the complete train display HTML
                    // This replaces the static "Loading..." text with live train data
                    display.innerHTML = `
            <div id="countdown" style="
              font-family: 'Courier New', monospace;
              font-size: 120px;
              font-weight: bold;
              margin: 20px 0;
              color: #000;
              text-align: left;
              letter-spacing: 4px;
              min-height: 120px;
              display: flex;
              align-items: center;
              justify-content: flex-start;
            "></div>
            <div style="margin: 10px 0; font-family: 'Courier New', monospace; font-size: 24px; color: #666;">From ${service.platform ? `Platform: ${service.platform}` : ''}</div>
            ${service.isCancelled ? '<div style="color: red; font-weight: bold;">CANCELLED</div>' : ''}
            ${service.delayReason ? `<div style="color: #666;">Delay reason: ${service.delayReason}</div>` : ''}
          `;

                    // Start the real-time countdown timer
                    startCountdown(service.std, service.etd);
                } else {
                    // No trains found - show appropriate message
                    display.innerHTML = '<div>No trains found for this route.</div>';
                }

            } catch (error) {
                // Error handling: Show error message if API call fails
                console.error('Error fetching train data:', error);
                display.innerHTML = `
          Failed to fetch train data: ${error.message}
          Make sure your server is running on port 3000.
        `;
            }
        }

        // Function to start the countdown timer
        function startCountdown(scheduledTime, expectedTime) {
            const countdownElement = document.getElementById('countdown');
            if (!countdownElement) return;

            // Use expected time if available and not "On time", otherwise use scheduled time
            const targetTime = expectedTime && expectedTime !== 'On time' ? expectedTime : scheduledTime;

            // Handle missing or invalid departure times
            if (!targetTime || targetTime === 'N/A') {
                countdownElement.innerHTML = '--:--<br><span style="font-size: 24px; color: #666;">Time unavailable</span>';
                countdownElement.style.color = '#ffaa00';
                countdownElement.style.textShadow = '0 0 10px #ffaa00';
                return;
            }

            // Inner function that calculates and displays the countdown
            function updateCountdown() {
                const now = new Date();
                const target = new Date();

                // Parse the time string (handles formats like "14:30" or "2:30 PM")
                const timeMatch = targetTime.match(/(\d{1,2}):(\d{2})/);
                if (!timeMatch) {
                    countdownElement.innerHTML = '--:--<br><span style="font-size: 24px; color: #666;">Invalid time format</span>';
                    countdownElement.style.color = '#ff0000';
                    countdownElement.style.textShadow = '0 0 10px #ff0000';
                    return;
                }

                let hours = parseInt(timeMatch[1]);
                const minutes = parseInt(timeMatch[2]);

                // Handle 12-hour format conversion (if PM and not 12, add 12; if AM and 12, make 0)
                if (targetTime.includes('PM') && hours !== 12) {
                    hours += 12;
                } else if (targetTime.includes('AM') && hours === 12) {
                    hours = 0;
                }

                // Set the target departure time for today
                target.setHours(hours, minutes, 0, 0);

                // If the target time has already passed today, assume it's for tomorrow
                if (target <= now) {
                    target.setDate(target.getDate() + 1);
                }

                // Calculate time difference in milliseconds
                const diff = target - now;

                // Handle case where train has already departed
                if (diff <= 0) {
                    countdownElement.innerHTML = '00:00<br><span style="font-size: 24px; color: #666;">Train departed</span>';
                    countdownElement.style.color = '#ff0000';
                    countdownElement.style.textShadow = '0 0 10px #ff0000';
                    return;
                }

                // Convert to hours and minutes remaining
                const totalMinutes = Math.floor(diff / (1000 * 60));
                const hoursLeft = Math.floor(totalMinutes / 60);
                const minutesLeft = totalMinutes % 60;

                // Display countdown with proper formatting
                if (hoursLeft > 0) {
                    countdownElement.innerHTML = `${hoursLeft.toString().padStart(2, '0')}:${minutesLeft.toString().padStart(2, '0')}<br><span style="font-size: 24px; color: #666;">hours from now</span>`;
                } else {
                    countdownElement.innerHTML = `00:${minutesLeft.toString().padStart(2, '0')}<br><span style="font-size: 24px; color: #666;">hours from now</span>`;
                }
            }

            // Start the countdown: update immediately, then every second
            updateCountdown();
            const interval = setInterval(updateCountdown, 1000);

            // Store interval ID in DOM element so we can clear it later when new data arrives
            countdownElement.dataset.intervalId = interval;
        }

        // Function to clear the countdown timer
        function clearCountdown() {
            const countdownElement = document.getElementById('countdown');
            if (countdownElement && countdownElement.dataset.intervalId) {
                clearInterval(countdownElement.dataset.intervalId);
            }
        }


        // Smart refresh intervals based on time to departure
        function scheduleNextUpdate() {
            // Fetch new train data, then schedule the next fetch based on how close the train is
            getNextTrain().then(() => {
                let nextRefresh = 30 * 1000; // Default fallback (30 seconds)

                // Calculate how long until the next departure to determine refresh frequency
                if (currentDepartureTime) {
                    const now = new Date();
                    const departure = new Date();
                    const timeMatch = currentDepartureTime.match(/(\d{1,2}):(\d{2})/);

                    if (timeMatch) {
                        let hours = parseInt(timeMatch[1]);
                        const minutes = parseInt(timeMatch[2]);

                        // Handle 12-hour format conversion
                        if (currentDepartureTime.includes('PM') && hours !== 12) {
                            hours += 12;
                        } else if (currentDepartureTime.includes('AM') && hours === 12) {
                            hours = 0;
                        }

                        departure.setHours(hours, minutes, 0, 0);

                        // If time has passed today, assume tomorrow
                        if (departure <= now) {
                            departure.setDate(departure.getDate() + 1);
                        }

                        const totalMinutes = Math.floor((departure - now) / (1000 * 60));

                        // ADAPTIVE REFRESH RATES: More frequent updates as departure approaches
                        if (totalMinutes > 60) {
                            nextRefresh = 10 * 60 * 1000; // 10 minutes - train is far away, less frequent updates
                        } else if (totalMinutes > 15) {
                            nextRefresh = 5 * 60 * 1000;  // 5 minutes - getting closer, moderate updates
                        } else {
                            nextRefresh = 30 * 1000;      // 30 seconds - very close, frequent updates
                        }
                    }
                }

                // Schedule the next data fetch using the calculated interval
                setTimeout(scheduleNextUpdate, nextRefresh);
            });
        }

        // Start the smart refresh cycle
        scheduleNextUpdate();
    </script>
</body>

</html>